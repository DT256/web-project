<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đánh giá sản phẩm</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <h1 class="mb-4">Đánh giá sản phẩm</h1>

  <!-- Form đánh giá -->
  <form id="rateForm" enctype="multipart/form-data">
    <input type="hidden" id="productId" name="productId" th:value="${productId}" />

    <div class="mb-3">
      <label for="rating" class="form-label">Đánh giá (1-5 sao):</label>
      <input type="number" id="rating" name="rate" class="form-control" min="1" max="5" required>
    </div>

    <div class="mb-3">
      <label for="content" class="form-label">Nội dung đánh giá:</label>
      <textarea id="content" name="content" class="form-control" rows="4" placeholder="Nhập nội dung đánh giá"></textarea>
    </div>

    <div class="mb-3">
      <label for="files" class="form-label">Hình ảnh/Video:</label>
      <input type="file" id="files" name="files" class="form-control" accept="image/*,video/*" multiple>
      <small class="text-muted">Chọn hình ảnh hoặc video để tải lên.</small>
    </div>

    <div class="mt-4">
      <button type="button" class="btn btn-primary" id="submitRate">Gửi đánh giá</button>
      <a href="/" class="btn btn-secondary">Quay lại</a>
    </div>
  </form>

  <!-- Thông báo -->
  <div id="statusMessage" class="alert d-none mt-4" role="alert"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  $(document).ready(function () {
    // Lấy token từ localStorage (hoặc sessionStorage nếu bạn sử dụng)
    const token = localStorage.getItem("jwtToken");

    // Nếu không có token, chuyển hướng về trang đăng nhập
    if (!token) {
      alert("Bạn cần đăng nhập để thực hiện đánh giá.");
      window.location.href = "/login";
      return;
    }

    // Xử lý gửi đánh giá
    $("#submitRate").click(function () {
      const formData = new FormData();
      formData.append("productId", $("#productId").val());
      formData.append("rate", $("#rating").val());
      formData.append("content", $("#content").val());

      const files = $("#files")[0].files;
      for (let i = 0; i < files.length; i++) {
        formData.append("files", files[i]);
      }

      // Gửi dữ liệu tới API
      $.ajax({
        url: "/api/rates/add",
        method: "POST",
        processData: false,
        contentType: false,
        headers: {
          "Authorization": `Bearer ${token}` // Thêm token vào header
        },
        data: formData,
        success: function (response) {
          $("#statusMessage").removeClass("d-none alert-danger").addClass("alert-success").text(response);
          setTimeout(() => window.location.href = "/", 2000); // Quay về trang chính sau khi đánh giá
        },
        error: function (xhr) {
          const errorMsg = xhr.responseText || "Đã xảy ra lỗi!";
          $("#statusMessage").removeClass("d-none alert-success").addClass("alert-danger").text(errorMsg);
        }
      });
    });
  });
</script>
</body>
</html>
